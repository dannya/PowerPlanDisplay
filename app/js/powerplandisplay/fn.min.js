"use strict";const Promise=require("bluebird"),execSync=require("child_process").execSync,execAsync=Promise.promisify(require("child_process").exec),trim=require("trim-character"),electron=require("electron"),traverse=require("traverse");var fn={_parsePowerPlan:function(e){var n=e.split("  "),r=n[0].split(": ")[1],t=trim.right(n[1],"\r"),i=!1,o=-1===powerplandisplay.hiddenPowerPlans.indexOf(r);return"*"===t.slice(-1)&&(i=!0,t=trim.right(t," *")),{guid:r,name:trim.left(trim.right(t,")"),"("),active:i,hidden:o}},getPowerPlans:function(){return new Promise(function(e,n){execAsync("powercfg /list").then(function(n){var r=[],t=n.split("\n").slice(3);for(var i in t)""!==t[i]&&r.push(fn._parsePowerPlan(t[i]));e(r)})["catch"](n)})},getPowerPlansSync:function(){var e=execSync("powercfg /list",{encoding:"utf-8"}),n=e.split("\n").slice(3),r=n.join("\n").replace(/(\()|(\))/g,"").replace("*","(Active)");return r},getActivePowerPlan:function(){return new Promise(function(e,n){execAsync("powercfg /getactivescheme").then(function(n){e(fn._parsePowerPlan(n))})["catch"](n)})},changeActivePowerplan:function(e){return new Promise(function(n,r){execAsync("powercfg /setactive "+e).then(n)["catch"](r)})},createWindow:function(){var e=powerplandisplay.config.frame===!0?"frame":"noframe",n=new electron.BrowserWindow({width:powerplandisplay.themes[powerplandisplay.config.theme][e].width,height:powerplandisplay.themes[powerplandisplay.config.theme][e].height,minWidth:200,minHeight:40,alwaysOnTop:powerplandisplay.config.notOnTop===!1&&powerplandisplay.config.debug===!1,darkTheme:!0,fullscreen:!1,frame:powerplandisplay.config.frame===!0,titleBarStyle:"hidden",webPreferences:{zoomFactor:1,plugins:!0,webSecurity:!1,webaudio:!0,experimentalFeatures:!0,experimentalCanvasFeatures:!0},title:powerplandisplay.sys.name+" v"+powerplandisplay.sys.version});n.loadURL("http://localhost:"+powerplandisplay.config.port+"/index.html?context=electron"),n.setAutoHideMenuBar(!0),n.setMenuBarVisibility(!1),powerplandisplay.config.webInspector===!0&&n.webContents.openDevTools(),n.on("page-title-updated",function(e){e.preventDefault()}),n.webContents.on("new-window",function(e,n){e.preventDefault(),electron.shell.openExternal(n)}),n.on("closed",function(){n=null});var r=electron.powerSaveBlocker.start("prevent-display-sleep");return{win:n,powersave:r}},update:function(e,n){traverse(powerplandisplay).set(e,n),e.unshift("powerplandisplay"),ipc.emit("setData",{keyPath:e,data:n})}};module.exports=fn;